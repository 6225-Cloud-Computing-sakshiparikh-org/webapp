name: Web App Tests

on:
    pull_request_target:
        branches: [ main ]

jobs:
    test:
        runs-on: ubuntu-latest

        services:
            mysql:
                image: mysql:8.0
                ports:
                    - 3306:3306
                env:
                    MYSQL_ROOT_PASSWORD: ${{ secrets.MYSQL_ROOT_PASSWORD }}
                    MYSQL_DATABASE: ${{ secrets.MYSQL_DATABASE }}
                    MYSQL_USER: ${{ secrets.MYSQL_USER }}
                    MYSQL_PASSWORD: ${{ secrets.MYSQL_PASSWORD }}
                options: >-
                    --health-cmd="mysqladmin ping --silent" 
                    --health-interval=10s 
                    --health-timeout=5s 
                    --health-retries=3

        env:
            # These environment variables are used by your application to connect to MySQL.
            DB_NAME: ${{ secrets.DB_NAME }}
            DB_USER: ${{ secrets.DB_USER }}
            DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
            DB_HOST: ${{ secrets.DB_HOST }}
            PORT: ${{ secrets.DB_PORT }}

        steps:
            - name: Checkout code
              uses: actions/checkout@v3

            - name: Setup Node.js
              uses: actions/setup-node@v3
              with:
                  node-version: "16"

            - name: Install dependencies
              run: npm install

            - name: Wait for MySQL to be ready
              run: |
                  for i in {1..30}; do
                    nc -z $DB_HOST 3306 && break || sleep 1
                  done

            - name: Run tests
              run: npm test
